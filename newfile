import React, { useCallback, useState, useEffect } from 'react';
import { useDropzone } from 'react-dropzone';
import axios from 'axios';
import './FileUploadBox.css';

const FileUploadBox = () => {
  const [files, setFiles] = useState([]);
  const [invalidFiles, setInvalidFiles] = useState([]);

  const onDrop = useCallback(acceptedFiles => {
    const updatedFiles = acceptedFiles.map(file => ({
      file: file,
      preview: file.type.startsWith('image/') ? URL.createObjectURL(file) : null,
      size: (file.size / 1024).toFixed(2) + ' KB',
      progress: 0,
      conversionType: null,
      status: 'pending'
    }));

    const validatedFiles = validateFiles(updatedFiles);
    const validFiles = validatedFiles.validFiles;
    const invalidFiles = validatedFiles.invalidFiles;

    setFiles(prevFiles => [...prevFiles, ...validFiles]);
    setInvalidFiles(prevInvalidFiles => [...prevInvalidFiles, ...invalidFiles]);

    validFiles.forEach(uploadFile);
  }, []);

  const validateFiles = (files) => {
    let validFiles = [];
    let invalidFiles = [];

    files.forEach(file => {
      if (file.file.type === 'application/json' || file.file.type === 'text/plain') {
        validFiles.push(file);
      } else {
        try {
          JSON.parse(file.file.name);
          validFiles.push(file);
        } catch (error) {
          invalidFiles.push(file);
        }
      }
    });

    return { validFiles, invalidFiles };
  };

  const uploadFile = (fileObj) => {
    const formData = new FormData();
    formData.append('file', fileObj.file);

    axios.post('http://localhost:8080/api/upload', formData, {
      onUploadProgress: (progressEvent) => {
        const progress = (progressEvent.loaded / progressEvent.total) * 100;
        setFiles(prevFiles => prevFiles.map(prevFile =>
          prevFile.file === fileObj.file
            ? { ...prevFile, progress }
            : prevFile
        ));
      }
    })
    .then(response => {
      setFiles(prevFiles => prevFiles.map(prevFile =>
        prevFile.file === fileObj.file
          ? { ...prevFile, status: 'uploaded', serverFileName: response.data.fileName }
          : prevFile
      ));
    })
    .catch(error => {
      console.error("Error uploading file:", error);
      setFiles(prevFiles => prevFiles.map(prevFile =>
        prevFile.file === fileObj.file
          ? { ...prevFile, status: 'error' }
          : prevFile
      ));
    });
  };

  const handleConversionTypeChange = (file, conversionType) => {
    setFiles(prevFiles =>
      prevFiles.map(prevFile =>
        prevFile.file === file ? { ...prevFile, conversionType } : prevFile
      )
    );
  };

  const convertFile = (file) => {
    axios.post('http://localhost:8080/api/convert', {
      fileName: file.serverFileName,
      conversionType: file.conversionType
    }, {
      responseType: 'blob'
    })
    .then(response => {
      const blob = new Blob([response.data], { type: response.headers['content-type'] });
      const downloadUrl = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = `${file.file.name.split('.')[0]}.${file.conversionType}`;
      document.body.appendChild(link);
      link.click();
      link.remove();
    })
    .catch(error => {
      console.error("Error converting file:", error);
    });
  };

  useEffect(() => {
    return () => {
      files.forEach(file => {
        if (file.preview) {
          URL.revokeObjectURL(file.preview);
        }
      });
    };
  }, [files]);

  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    onDrop,
    accept: '.json,application/json,text/plain',
    multiple: true
  });

  return (
    <div className="upload-container">
      <div
        {...getRootProps()}
        className={`dropzone ${isDragActive ? 'active' : ''}`}
      >
        <input {...getInputProps()} />
        {isDragActive ? (
          <p>Drop files here ...</p>
        ) : (
          <p>Drop JSON files here / Click to select JSON files</p>
        )}
      </div>
      {invalidFiles.length > 0 && (
        <div className="invalid-files">
          <h3>Invalid Files:</h3>
          <ul>
            {invalidFiles.map((invalidFile, index) => (
              <li key={index}>{invalidFile.file.name}</li>
            ))}
          </ul>
          <p>Accepted formats: JSON file, JSON text</p>
        </div>
      )}
      {files.map(file => (
        <div className="file-container" key={file.file.name}>
          <div className="file-preview">
            {file.preview ? (
              <img
                src={file.preview}
                alt={file.file.name}
                className="preview-image"
              />
            ) : (
              <div className="file-icon">
                <p>{file.file.name}</p>
              </div>
            )}
            <div className="file-details">
              <div className="file-detail">
                <strong>Name:</strong> {file.file.name}
              </div>
              <div className="file-detail">
                <strong>Size:</strong> {file.size}
              </div>
              <div className="file-detail">
                <strong>Status:</strong> {file.progress}%
              </div>
              <div className="progress-bar">
                <div
                  className="progress"
                  style={{ width: `${file.progress}%` }}
                ></div>
              </div>
              {file.status === 'uploaded' && (
                <div className="conversion-options">
                  <label>Convert to:</label>
                  <select
                    value={file.conversionType || ''}
                    onChange={(e) => handleConversionTypeChange(file.file, e.target.value)}
                  >
                    <option value="">Select...</option>
                    <option value="csv">CSV</option>
                    <option value="txt">TXT</option>
                    <option value="xml">XML</option>
                    <option value="pdf">PDF</option>
                    <option value="doc">DOC</option>
                  </select>
                  {file.conversionType && (
                    <button onClick={() => convertFile(file)}>Convert</button>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      ))}
    </div>
  );
};

export default FileUploadBox;
